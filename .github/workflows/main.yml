name: Public RDP on Port 443

on: 
  workflow_dispatch:

jobs:
  public-rdp:
    runs-on: windows-latest
    timeout-minutes: 0
    
    steps:
      - name: Configure RDP Settings for Port 443
        run: |
          # تمكين RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # إزالة المصادقة بالكامل
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # تغيير المنفذ من 3389 إلى 443
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "PortNumber" -Value 443 -Type DWord -Force
          
          # تكوين جدار الحماية للمنفذ 443
          netsh advfirewall firewall delete rule name="Public-RDP-443"
          netsh advfirewall firewall add rule name="Public-RDP-443" dir=in action=allow protocol=TCP localport=443
          
          # إضافة قاعدة DNS للمنفذ 443
          netsh interface portproxy delete v4tov4 listenport=443
          netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=443 connectaddress=127.0.0.1
          
          # إعادة تشغيل خدمة RDP
          Restart-Service -Name TermService -Force

      - name: Create Administrator User
        run: |
          $password = "Admin@Secure123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # إنشاء مستخدم جديد
          if (-not (Get-LocalUser -Name "PublicAdmin" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "PublicAdmin" -Password $securePass -AccountNeverExpires
          }
          
          # إضافة المستخدم إلى المجموعات المطلوبة
          Add-LocalGroupMember -Group "Administrators" -Member "PublicAdmin" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "PublicAdmin" -ErrorAction SilentlyContinue
          
          # تكوين سياسات المستخدم
          net user PublicAdmin /active:yes
          net user PublicAdmin /passwordchg:no
          net user PublicAdmin /expires:never
          
          # تخزين البيانات في متغيرات GitHub
          echo "RDP_USER=PublicAdmin" >> $env:GITHUB_ENV
          echo "RDP_PASS=Admin@Secure123" >> $env:GITHUB_ENV

      - name: Get Public IP Address
        id: ip
        run: |
          $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org?format=json").ip
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          echo "RDP_CONNECTION=$publicIP:443" >> $env:GITHUB_ENV
          Write-Host "Public IP Address: $publicIP"

      - name: Disable Windows Firewall Restrictions
        run: |
          # تعطيل جدار الحماية مؤقتاً
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          
          # تكوين سياسات الشبكة
          netsh advfirewall set allprofiles state off
          
          # السماح بجميع الاتصالات الواردة
          netsh advfirewall firewall add rule name="Allow All Inbound" dir=in action=allow

      - name: Configure Network Level Authentication (NLA)
        run: |
          # تعطيل مصادقة مستوى الشبكة
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          
          # تكوين إعدادات RDP إضافية
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fPromptForPassword" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fAllowToGetHelp" -Value 1 -Force

      - name: Test RDP Connection
        run: |
          Write-Host "Testing RDP port 443 locally..."
          $testResult = Test-NetConnection -ComputerName 127.0.0.1 -Port 443
          
          if ($testResult.TcpTestSucceeded) {
              Write-Host "✓ RDP is working on port 443"
          } else {
              Write-Host "✗ RDP port test failed, checking configuration..."
              Get-NetTCPConnection -LocalPort 443
          }
          
          # عرض حالة خدمات RDP
          Get-Service TermService, SessionEnv

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "================================================"
          Write-Host "           PUBLIC RDP CONNECTION READY          "
          Write-Host "================================================"
          Write-Host "Public IP Address: $env:PUBLIC_IP"
          Write-Host "Port: 443 (HTTPS)"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host ""
          Write-Host "Connection String:"
          Write-Host "mstsc /v:$env:PUBLIC_IP:443"
          Write-Host ""
          Write-Host "================================================"
          Write-Host "Note: Keep this workflow running in background"
          Write-Host "================================================"

      - name: Keep RDP Alive (Background Process)
        run: |
          # إنشاء سكربت للبقاء نشطاً
          $keepAliveScript = @"
          while (`$true) {
              `$currentTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              Write-Host "[`$currentTime] RDP is active on port 443"
              Write-Host "Public IP: $env:PUBLIC_IP"
              Write-Host "User: $env:RDP_USER"
              Write-Host ""
              
              # التحقق من حالة الخدمة
              `$serviceStatus = Get-Service TermService | Select-Object Status
              if (`$serviceStatus.Status -ne "Running") {
                  Write-Host "Restarting RDP service..."
                  Start-Service TermService
              }
              
              # التحقق من المنفذ
              `$portCheck = Get-NetTCPConnection -LocalPort 443 -ErrorAction SilentlyContinue
              if (-not `$portCheck) {
                  Write-Host "Port 443 not listening, reconfiguring..."
                  netsh advfirewall firewall add rule name="RDP-443" dir=in action=allow protocol=TCP localport=443
              }
              
              Start-Sleep -Seconds 60
          }
"@
          
          # تنفيذ السكربت في الخلفية
          $scriptPath = "$env:TEMP\KeepRDPAlive.ps1"
          $keepAliveScript | Out-File -FilePath $scriptPath -Encoding UTF8
          
          # تشغيل السكربت كعملية منفصلة
          Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$scriptPath`"" -WindowStyle Hidden
          
          # البقاء في العملية الرئيسية لمنع توقف الworkflow
          while ($true) {
              Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] RDP Session Active"
              Write-Host "Server will remain online until manually stopped"
              Write-Host "Press Ctrl+C in GitHub Actions to stop"
              
              # عرض معلومات النظام
              $uptime = (Get-Date) - (Get-CimInstance -ClassName Win32_OperatingSystem).LastBootUpTime
              Write-Host "Uptime: $($uptime.Days) days, $($uptime.Hours) hours, $($uptime.Minutes) minutes"
              
              Start-Sleep -Seconds 300
          }

      - name: Cleanup on Stop
        if: always()
        run: |
          Write-Host "Cleaning up RDP configuration..."
          
          # إعادة تعيين المنفذ الافتراضي
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "PortNumber" -Value 3389 -Type DWord -Force
          
          # إعادة تمكين المصادقة
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 2 -Force
          
          # حذف قواعد جدار الحماية
          netsh advfirewall firewall delete rule name="Public-RDP-443"
          netsh advfirewall firewall delete rule name="Allow All Inbound"
          
          # تمكين جدار الحماية
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
          
          # إعادة تشغيل خدمة RDP
          Restart-Service -Name TermService -Force
          
          Write-Host "Cleanup completed"
