name: VPS Server
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 28800

    steps:
      - name: Configure Windows as VPS
        run: |
          Write-Host "Configuring Windows as VPS Server..."
          
          # ØªØ¹Ø·ÙŠÙ„ ÙƒØ§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø§Ù‚Ø©
          powercfg -change -standby-timeout-ac 0
          powercfg -change -hibernate-timeout-ac 0
          powercfg -change -monitor-timeout-ac 0
          powercfg -change -disk-timeout-ac 0
          powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c

          # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
          Stop-Service -Name "wuauserv" -Force
          Set-Service -Name "wuauserv" -StartupType Disabled
          Stop-Service -Name "UsoSvc" -Force
          Set-Service -Name "UsoSvc" -StartupType Disabled

          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoUpdate" -Value 1 -Force
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -Name "NoAutoRebootWithLoggedOnUsers" -Value 1 -Force

          Write-Host "VPS base configuration completed"

      - name: Create VPS Admin User
        run: |
          $username = "VPSADMIN"
          $password = "admin@123"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… VPS
          Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePassword -AccountNeverExpires
          
          # Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          Set-LocalUser -Name $username -PasswordNeverExpires $true
          
          echo "VPS_USER=$username" >> $env:GITHUB_ENV
          echo "VPS_PASSWORD=$password" >> $env:GITHUB_ENV
          Write-Host "VPS Admin user created successfully"

      - name: Enable and Configure RDP for VPS
        run: |
          # ØªÙ…ÙƒÙŠÙ† RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù…Ù†Ø¹ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxConnectionTime" -Value 2147483647 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxDisconnectionTime" -Value 2147483647 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "MaxIdleTime" -Value 2147483647 -Force
          
          # ÙØªØ­ Ù…Ù†ÙØ° RDP
          netsh advfirewall firewall add rule name="VPS-RDP" dir=in action=allow protocol=TCP localport=3389
          
          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
          Restart-Service -Name TermService -Force
          Write-Host "RDP configured for VPS access"

      - name: Install Tailscale for VPS Networking
        run: |
          Write-Host "Installing Tailscale for VPS networking..."
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -Wait -ArgumentList @(
            "/i",
            "`"$installerPath`"",
            "/quiet",
            "/norestart"
          )
          Remove-Item $installerPath -Force
          Start-Sleep -Seconds 10
          Write-Host "Tailscale installed successfully"

      - name: Setup Persistent Tailscale Connection
        run: |
          Write-Host "Setting up persistent Tailscale connection..."
          
          # ØªØ´ØºÙŠÙ„ Tailscale Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª VPS
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vps-server-20d --accept-routes --accept-dns --reset
          
          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
          $tsIP = $null
          for ($i = 1; $i -le 25; $i++) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($tsIP) {
                  echo "VPS_IP=$tsIP" >> $env:GITHUB_ENV
                  Write-Host "VPS IP Address: $tsIP"
                  break
              }
              Write-Host "Waiting for VPS IP... ($i/25)"
              Start-Sleep -Seconds 4
          }
          
          if (-not $tsIP) {
              Write-Host "Using alternative method to get IP..."
              try {
                  $status = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
                  $tsIP = $status.Self.TailscaleIPs[0]
                  if ($tsIP) {
                      echo "VPS_IP=$tsIP" >> $env:GITHUB_ENV
                  }
              } catch {
                  Write-Host "Could not get IP, but continuing..."
              }
          }

      - name: Configure VPS Services
        run: |
          Write-Host "Configuring VPS services..."
          
          # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù„Ù„Ù€ VPS
          $servicesToDisable = @(
              "XboxGipSvc",
              "XboxNetApiSvc", 
              "WSearch",
              "TabletInputService",
              "Fax",
              "MapsBroker"
          )
          
          foreach ($service in $servicesToDisable) {
              Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
              Set-Service -Name $service -StartupType Disabled -ErrorAction SilentlyContinue
          }
          
          # ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù‡Ø§Ù…Ø©
          $servicesToEnable = @(
              "TermService",
              "SessionEnv",
              "UmRdpService"
          )
          
          foreach ($service in $servicesToEnable) {
              Set-Service -Name $service -StartupType Automatic -ErrorAction SilentlyContinue
              Start-Service -Name $service -ErrorAction SilentlyContinue
          }
          
          Write-Host "VPS services configured"

      - name: Create VPS Maintenance Script
        run: |
          Write-Host "Creating VPS maintenance script..."
          
          $maintenanceScript = @'
          # VPS Maintenance Script
          `$logPath = "C:\vps-status.log"
          `$startTime = Get-Date
          `$endTime = `$startTime.AddDays(20)
          
          function Log-Message {
              param([string]`$message)
              `$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              `$logEntry = "[`$timestamp] `$message"
              Add-Content -Path `$logPath -Value `$logEntry
              Write-Host `$logEntry
          }
          
          Log-Message "VPS Server started - 20 days session"
          
          while ((Get-Date) -lt `$endTime) {
              `$remaining = `$endTime - (Get-Date)
              `$days = [math]::Round(`$remaining.TotalDays, 2)
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
              `$essentialServices = @("TermService", "SessionEnv")
              foreach (`$service in `$essentialServices) {
                  `$svc = Get-Service -Name `$service -ErrorAction SilentlyContinue
                  if (`$svc.Status -ne "Running") {
                      Log-Message "Service `$service is not running - restarting"
                      Start-Service -Name `$service -Force
                  }
              }
              
              # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Tailscale ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
              if ((Get-Date).Minute % 30 -eq 0) {
                  try {
                      `$currentIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
                      if (-not `$currentIP) {
                          Log-Message "Tailscale disconnected - reconnecting"
                          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --reset
                      }
                  } catch {
                      Log-Message "Tailscale check failed: `$(`_.Exception.Message)"
                  }
              }
              
              # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ Ø³Ø§Ø¹Ø©
              if ((Get-Date).Minute % 60 -eq 0) {
                  Log-Message "VPS Active - `$days days remaining - IP: `$(`$currentIP)"
              }
              
              Start-Sleep -Seconds 300
          }
          
          Log-Message "VPS 20-day session completed successfully"
'@
          
          Set-Content -Path "C:\vps-maintenance.ps1" -Value $maintenanceScript
          Write-Host "VPS maintenance script created"

      - name: Start VPS Server
        run: |
          Write-Host "Starting VPS Server..."
          
          # Ø¨Ø¯Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØµÙŠØ§Ù†Ø©
          Start-Process PowerShell.exe -ArgumentList "-WindowStyle Hidden -File C:\vps-maintenance.ps1" -WindowStyle Hidden
          
          Write-Host ""
          Write-Host "========================================================"
          Write-Host "ğŸ¯ VPS SERVER READY - 20 DAYS"
          Write-Host "========================================================"
          Write-Host "ğŸŒ IP Address: $env:VPS_IP"
          Write-Host "ğŸ‘¤ Username: $env:VPS_USER"
          Write-Host "ğŸ”‘ Password: $env:VPS_PASSWORD"
          Write-Host ""
          Write-Host "â° Duration: 20 DAYS"
          Write-Host "ğŸ• Start: $(Get-Date)"
          Write-Host "ğŸ“… End: $((Get-Date).AddDays(20))"
          Write-Host ""
          Write-Host "ğŸ”§ Features:"
          Write-Host "  â€¢ Full Windows VPS"
          Write-Host "  â€¢ Persistent Connection"
          Write-Host "  â€¢ Static IP"
          Write-Host "  â€¢ 24/7 Availability"
          Write-Host "  â€¢ Auto Maintenance"
          Write-Host "========================================================"
          Write-Host ""

      - name: Keep VPS Alive for 20 Days
        run: |
          $totalSeconds = 20 * 24 * 60 * 60  # 20 ÙŠÙˆÙ… Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
          $checkInterval = 300  # ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
          $totalChecks = $totalSeconds / $checkInterval
          $checkCount = 0
          
          for ($i = 0; $i -lt $totalChecks; $i++) {
              $currentTime = Get-Date
              $elapsed = $currentTime - (Get-Date).AddDays(-20).AddSeconds($totalSeconds)
              $remainingDays = 20 - [math]::Round($elapsed.TotalDays, 2)
              
              # Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ Ø³Ø§Ø¹Ø©
              if ($checkCount % 12 -eq 0) {
                  Write-Host "[$(Get-Date)] VPS Server Active - $remainingDays days remaining"
                  
                  # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                  try {
                      if (Test-Path "C:\vps-status.log") {
                          $lastLog = Get-Content "C:\vps-status.log" -Tail 1 -ErrorAction SilentlyContinue
                          if ($lastLog) {
                              Write-Host "Last log: $lastLog"
                          }
                      }
                  } catch {
                      # ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                  }
              }
              
              # ÙØ­Øµ Ø´Ø§Ù…Ù„ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
              if ($checkCount % 72 -eq 0) {
                  Write-Host "Performing VPS health check..."
                  
                  # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª
                  $services = @("TermService", "SessionEnv")
                  foreach ($service in $services) {
                      $svc = Get-Service -Name $service -ErrorAction SilentlyContinue
                      if ($svc.Status -ne "Running") {
                          Write-Host "Starting service: $service"
                          Start-Service -Name $service -Force
                      }
                  }
                  
                  # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Tailscale
                  try {
                      $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                      if (-not $currentIP) {
                          Write-Host "Reconnecting Tailscale..."
                          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --reset
                      } else {
                          Write-Host "Tailscale IP: $currentIP"
                      }
                  } catch {
                      Write-Host "Tailscale check error: $($_.Exception.Message)"
                  }
                  
                  Write-Host "VPS health check completed"
              }
              
              $checkCount++
              Start-Sleep -Seconds $checkInterval
          }
          
          Write-Host "========================================================"
          Write-Host "âœ… VPS 20-DAY SESSION COMPLETED"
          Write-Host "ğŸ• Finished at: $(Get-Date)"
          Write-Host "========================================================"
