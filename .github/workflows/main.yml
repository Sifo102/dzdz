name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 10080
    steps:
      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          netsh advfirewall firewall add rule name="RDP-DuckDNS" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ RDP configured successfully"

      - name: Create User Account
        run: |
          $password = "P@ssw0rd123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          Remove-LocalUser -Name "SIFODZ" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          New-LocalUser -Name "SIFODZ" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "SIFODZ"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "SIFODZ"
          Enable-LocalUser -Name "SIFODZ"
          Write-Host "‚úÖ User account created"

      - name: Get Public IP and Update DuckDNS
        run: |
          # Get current public IP
          $publicIP = Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 10
          Write-Host "üåç Public IP: $publicIP"
          
          # Update DuckDNS with your domain and token
          $duckdnsToken = "6057ecf3-d13f-4440-9544-466fee7eb60b"
          $duckdnsDomain = "sifogmlj"
          
          $updateUrl = "https://www.duckdns.org/update?domains=$duckdnsDomain&token=$duckdnsToken&ip=$publicIP"
          $result = Invoke-RestMethod -Uri $updateUrl
          
          if ($result -eq "OK") {
              Write-Host "‚úÖ DuckDNS updated successfully: sifogmlj.duckdns.org -> $publicIP"
          } else {
              Write-Host "‚ùå DuckDNS update failed: $result"
              exit 1
          }

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "üéØ ==================== RDP CONNECTION READY ===================="
          Write-Host "üë§ Username: SIFODZ"
          Write-Host "üîë Password: P@ssw0rd123"
          Write-Host "üåê Address: sifogmlj.duckdns.org:3389"
          Write-Host "üì° Public IP: 52.190.140.96"
          Write-Host ""
          Write-Host "üîß HOW TO CONNECT:"
          Write-Host "   1. Open Remote Desktop Connection (press Windows + R, type 'mstsc')"
          Write-Host "   2. In Computer field enter: sifogmlj.duckdns.org:3389"
          Write-Host "   3. Username: SIFODZ"
          Write-Host "   4. Password: P@ssw0rd123"
          Write-Host "   5. Click Connect"
          Write-Host ""
          Write-Host "‚è∞ Duration: 7 DAYS"
          Write-Host "================================================================"
          Write-Host ""

      - name: Maintain RDP Service
        run: |
          $startTime = Get-Date
          Write-Host "üîÑ RDP Server is running and waiting for connections..."
          Write-Host "üìç Connect to: sifogmlj.duckdns.org:3389"
          Write-Host "üë§ Username: SIFODZ"
          Write-Host "üîë Password: P@ssw0rd123"
          Write-Host ""
          
          while ($true) {
              $currentTime = Get-Date
              $elapsed = $currentTime - $startTime
              $hours = [math]::Round($elapsed.TotalHours, 1)
              
              # Check RDP service
              $rdpService = Get-Service -Name TermService
              if ($rdpService.Status -ne 'Running') {
                  Write-Host "üîÑ Restarting RDP Service..."
                  Start-Service -Name TermService
              }
              
              # Update DuckDNS every 30 minutes
              if ((Get-Date).Minute % 30 -eq 0) {
                  try {
                      $publicIP = Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 10
                      $duckdnsToken = "6057ecf3-d13f-4440-9544-466fee7eb60b"
                      $duckdnsDomain = "sifogmlj"
                      $updateUrl = "https://www.duckdns.org/update?domains=$duckdnsDomain&token=$duckdnsToken&ip=$publicIP"
                      $result = Invoke-RestMethod -Uri $updateUrl
                      if ($result -eq "OK") {
                          Write-Host "üîÑ DuckDNS updated: sifogmlj.duckdns.org -> $publicIP"
                      }
                  } catch {
                      Write-Host "‚ö†Ô∏è DuckDNS update failed, will retry later"
                  }
              }
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚úÖ RDP Active - $hours hours - Address: sifogmlj.duckdns.org:3389"
              Start-Sleep -Seconds 60
          }
