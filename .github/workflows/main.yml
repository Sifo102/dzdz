name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 10080
    steps:
      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          netsh advfirewall firewall add rule name="RDP-ZeroTier" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ RDP configured successfully"

      - name: Create User Account
        run: |
          $password = "P@ssw0rd123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          Remove-LocalUser -Name "SIFODZ" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          New-LocalUser -Name "SIFODZ" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "SIFODZ"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "SIFODZ"
          Enable-LocalUser -Name "SIFODZ"
          Write-Host "‚úÖ User account created"

      - name: Install ZeroTier
        run: |
          $zerotierUrl = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          $installerPath = "$env:TEMP\zerotier.msi"
          Invoke-WebRequest -Uri $zerotierUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart", "ALLUSERS=1" -Wait
          Remove-Item $installerPath -Force
          Write-Host "‚úÖ ZeroTier installed successfully"

      - name: Join ZeroTier Network
        run: |
          $networkId = "54b8caa5df"
          
          Write-Host "üîó Joining ZeroTier network: $networkId"
          
          # Create network config file - this is the most reliable method
          $configDir = "$env:ProgramData\ZeroTier\One\networks.d"
          New-Item -ItemType Directory -Path $configDir -Force
          $configFile = "$configDir\$networkId.conf"
          Set-Content -Path $configFile -Value ""
          
          Write-Host "‚úÖ Created network config file"
          Write-Host "‚úÖ ZeroTier will automatically connect to the network"
          Write-Host "üìã Please authorize this device at: https://my.zerotier.com/network/54b8caa5df"

      - name: Wait for ZeroTier Connection
        run: |
          Write-Host "üîÑ Waiting for ZeroTier to establish connection (60 seconds)..."
          Start-Sleep -Seconds 60

      - name: Get Network Information
        run: |
          Write-Host "üîç Checking network configuration..."
          
          # Get all IP addresses
          $ipAddresses = Get-NetIPAddress -AddressFamily IPv4 | Where-Object { 
              $_.IPAddress -ne "127.0.0.1" -and $_.IPAddress -notlike "169.254.*"
          }
          
          Write-Host "üåê Available IP Addresses:"
          foreach ($ip in $ipAddresses) {
              Write-Host "   - $($ip.IPAddress) ($($ip.InterfaceAlias))"
          }
          
          # Try to identify ZeroTier IP
          $ztIP = $null
          $adapters = Get-NetAdapter | Where-Object { $_.InterfaceDescription -like "*ZeroTier*" }
          if ($adapters) {
              foreach ($adapter in $adapters) {
                  $adapterIPs = Get-NetIPAddress -InterfaceIndex $adapter.ifIndex -AddressFamily IPv4 -ErrorAction SilentlyContinue
                  if ($adapterIPs) {
                      $ztIP = $adapterIPs.IPAddress
                      Write-Host "üéØ ZeroTier IP Found: $ztIP"
                      break
                  }
              }
          }
          
          if ($ztIP) {
              echo "ZEROTIER_IP=$ztIP" >> $env:GITHUB_ENV
          } else {
              Write-Host "‚ö†Ô∏è ZeroTier IP not found - device needs authorization"
              echo "ZEROTIER_IP=pending_approval" >> $env:GITHUB_ENV
          }

      - name: Display Final Connection Info
        run: |
          Write-Host ""
          Write-Host "üéØ ==================== RDP CONNECTION ===================="
          Write-Host "üë§ Username: SIFODZ"
          Write-Host "üîë Password: P@ssw0rd123"
          Write-Host "üåê ZeroTier Network ID: 54b8caa5df"
          
          if ($env:ZEROTIER_IP -and $env:ZEROTIER_IP -ne "pending_approval") {
              Write-Host "üìç ZeroTier IP Address: $env:ZEROTIER_IP"
              Write-Host "üîå Port: 3389"
              Write-Host ""
              Write-Host "üîß HOW TO CONNECT:"
              Write-Host "   1. Install ZeroTier on your PC: https://www.zerotier.com/download/"
              Write-Host "   2. Join the same network: 54b8caa5df"
              Write-Host "   3. Go to: https://my.zerotier.com/network/54b8caa5df"
              Write-Host "   4. Authorize BOTH devices (this server and your PC)"
              Write-Host "   5. Connect via RDP to: $env:ZEROTIER_IP"
              Write-Host "   6. Username: SIFODZ"
              Write-Host "   7. Password: P@ssw0rd123"
          } else {
              Write-Host "üìç ZeroTier IP: Waiting for Authorization"
              Write-Host ""
              Write-Host "üìã REQUIRED ACTION:"
              Write-Host "   1. Open: https://my.zerotier.com/network/54b8caa5df"
              Write-Host "   2. Sign in to your ZeroTier account"
              Write-Host "   3. Find this device in the member list"
              Write-Host "   4. Check the 'Auth' checkbox"
              Write-Host "   5. Wait 1-2 minutes for IP assignment"
              Write-Host "   6. The IP will appear here automatically"
          }
          
          Write-Host ""
          Write-Host "üîí SECURITY FEATURES:"
          Write-Host "   ‚Ä¢ ZeroTier Encrypted VPN"
          Write-Host "   ‚Ä¢ Private Network Access"
          Write-Host "   ‚Ä¢ Secure RDP Connection"
          Write-Host ""
          Write-Host "‚è∞ Duration: 7 DAYS"
          Write-Host "=========================================================="
          Write-Host ""

      - name: Maintain RDP Service
        run: |
          $startTime = Get-Date
          Write-Host "üîÑ RDP Server is running and waiting for connections..."
          
          while ($true) {
              $currentTime = Get-Date
              $elapsed = $currentTime - $startTime
              $hours = [math]::Round($elapsed.TotalHours, 1)
              
              # Simple RDP service check (without complex service queries)
              try {
                  $rdpStatus = Get-Service -Name TermService -ErrorAction Stop
                  if ($rdpStatus.Status -ne 'Running') {
                      Write-Host "üîÑ Restarting RDP Service..."
                      Start-Service -Name TermService
                  }
              } catch {
                  Write-Host "‚ö†Ô∏è Could not check RDP service status"
              }
              
              # Periodically check for ZeroTier IP
              if ($env:ZEROTIER_IP -eq "pending_approval" -and (Get-Date).Minute % 5 -eq 0) {
                  try {
                      $adapters = Get-NetAdapter | Where-Object { $_.InterfaceDescription -like "*ZeroTier*" }
                      if ($adapters) {
                          foreach ($adapter in $adapters) {
                              $adapterIPs = Get-NetIPAddress -InterfaceIndex $adapter.ifIndex -AddressFamily IPv4 -ErrorAction SilentlyContinue
                              if ($adapterIPs -and $adapterIPs.IPAddress) {
                                  $newIP = $adapterIPs.IPAddress
                                  echo "ZEROTIER_IP=$newIP" >> $env:GITHUB_ENV
                                  Write-Host "üéØ ZeroTier IP Assigned: $newIP"
                                  break
                              }
                          }
                      }
                  } catch {
                      # Silent fail for IP checks
                  }
              }
              
              if ($env:ZEROTIER_IP -and $env:ZEROTIER_IP -ne "pending_approval") {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚úÖ RDP Active - $hours hours - IP: $env:ZEROTIER_IP"
              } else {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚è≥ Waiting Authorization - $hours hours"
                  Write-Host "   Please authorize at: https://my.zerotier.com/network/54b8caa5df"
              }
              
              Start-Sleep -Seconds 60
          }
