name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 10080
    steps:
      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          netsh advfirewall firewall add rule name="RDP-DuckDNS" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ RDP configured successfully"

      - name: Create User Account
        run: |
          $password = "P@ssw0rd123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          Remove-LocalUser -Name "SIFODZ" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          New-LocalUser -Name "SIFODZ" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "SIFODZ"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "SIFODZ"
          Enable-LocalUser -Name "SIFODZ"
          echo "RDP_USER=SIFODZ" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Get Public IP and Update DuckDNS
        run: |
          # Get current public IP
          $publicIP = Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 10
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          Write-Host "üåç Public IP: $publicIP"
          
          # Update DuckDNS with your domain and token
          $duckdnsToken = "6057ecf3-d13f-4440-9544-466fee7eb60b"
          $duckdnsDomain = "sifogmlj"
          
          $updateUrl = "https://www.duckdns.org/update?domains=$duckdnsDomain&token=$duckdnsToken&ip=$publicIP"
          $result = Invoke-RestMethod -Uri $updateUrl
          
          if ($result -eq "OK") {
              echo "DUCKDNS_URL=$duckdnsDomain.duckdns.org" >> $env:GITHUB_ENV
              Write-Host "‚úÖ DuckDNS updated successfully: $duckdnsDomain.duckdns.org -> $publicIP"
          } else {
              Write-Host "‚ùå DuckDNS update failed: $result"
              exit 1
          }

      - name: Install and Configure Cloudflared Tunnel
        run: |
          # Download Cloudflared
          $cloudflaredUrl = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
          $cloudflaredDir = "C:\cloudflared"
          $cloudflaredPath = "$cloudflaredDir\cloudflared.exe"
          
          New-Item -ItemType Directory -Path $cloudflaredDir -Force
          Invoke-WebRequest -Uri $cloudflaredUrl -OutFile $cloudflaredPath
          Write-Host "‚úÖ Cloudflared installed"

      - name: Start Cloudflared Tunnel
        run: |
          # Start Cloudflared tunnel in background
          $tunnelProcess = Start-Process -FilePath "C:\cloudflared\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389" -PassThru -WindowStyle Hidden
          echo "TUNNEL_PID=$($tunnelProcess.Id)" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Cloudflared tunnel started (PID: $($tunnelProcess.Id))"
          
          # Wait for tunnel to establish
          Write-Host "üîÑ Waiting for tunnel to initialize..."
          Start-Sleep -Seconds 15
          
          # Try to get tunnel URL
          try {
              $tunnelInfo = & "C:\cloudflared\cloudflared.exe" tunnel list --format json | ConvertFrom-Json
              if ($tunnelInfo.Count -gt 0) {
                  $tunnelUrl = $tunnelInfo[0].hostname
                  echo "TUNNEL_URL=$tunnelUrl" >> $env:GITHUB_ENV
                  Write-Host "üåê Cloudflared Tunnel URL: $tunnelUrl"
              }
          } catch {
              Write-Host "‚ö†Ô∏è Could not get Cloudflared URL, using DuckDNS only"
          }

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "üéØ ==================== RDP CONNECTION READY ===================="
          Write-Host "üë§ Username: $env:RDP_USER"
          Write-Host "üîë Password: $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "üåê CONNECTION METHODS:"
          Write-Host ""
          Write-Host "üìç METHOD 1 - DuckDNS (Recommended):"
          Write-Host "   Computer: $env:DUCKDNS_URL:3389"
          Write-Host "   Username: $env:RDP_USER"
          Write-Host "   Password: $env:RDP_PASSWORD"
          Write-Host ""
          if ($env:TUNNEL_URL) {
              Write-Host "üìç METHOD 2 - Cloudflared Tunnel:"
              Write-Host "   Computer: $env:TUNNEL_URL"
              Write-Host "   Username: $env:RDP_USER"
              Write-Host "   Password: $env:RDP_PASSWORD"
              Write-Host ""
          }
          Write-Host "üîß INSTRUCTIONS:"
          Write-Host "   1. Open Remote Desktop Connection (mstsc.exe)"
          Write-Host "   2. Enter the Computer address from above"
          Write-Host "   3. Use Username and Password shown"
          Write-Host "   4. Click Connect and enjoy!"
          Write-Host ""
          Write-Host "‚è∞ Duration: 7 DAYS"
          Write-Host "================================================================"
          Write-Host ""

      - name: Maintain Services and Update DuckDNS
        run: |
          $startTime = Get-Date
          Write-Host "üîÑ All services are running and monitoring..."
          
          while ($true) {
              $currentTime = Get-Date
              $elapsed = $currentTime - $startTime
              $hours = [math]::Round($elapsed.TotalHours, 1)
              
              # Check RDP service
              $rdpService = Get-Service -Name TermService
              if ($rdpService.Status -ne 'Running') {
                  Write-Host "üîÑ Restarting RDP Service..."
                  Start-Service -Name TermService
              }
              
              # Check Cloudflared tunnel
              $tunnelProcess = Get-Process -Name "cloudflared" -ErrorAction SilentlyContinue
              if (-not $tunnelProcess) {
                  Write-Host "üîÑ Restarting Cloudflared Tunnel..."
                  Start-Process -FilePath "C:\cloudflared\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389" -WindowStyle Hidden
              }
              
              # Update DuckDNS every 30 minutes to keep it fresh
              if ((Get-Date).Minute % 30 -eq 0) {
                  try {
                      $publicIP = Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 10
                      $duckdnsToken = "6057ecf3-d13f-4440-9544-466fee7eb60b"
                      $duckdnsDomain = "sifogmlj"
                      $updateUrl = "https://www.duckdns.org/update?domains=$duckdnsDomain&token=$duckdnsToken&ip=$publicIP"
                      $result = Invoke-RestMethod -Uri $updateUrl
                      if ($result -eq "OK") {
                          Write-Host "üîÑ DuckDNS updated: $duckdnsDomain.duckdns.org -> $publicIP"
                      }
                  } catch {
                      Write-Host "‚ö†Ô∏è DuckDNS update failed, will retry later"
                  }
              }
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚úÖ RDP Active - $hours hours - Connect to: $env:DUCKDNS_URL:3389"
              Start-Sleep -Seconds 60
          }
