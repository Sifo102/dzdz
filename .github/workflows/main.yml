name: Public RDP on Port 443 with Tunnel

on: 
  workflow_dispatch:

jobs:
  public-rdp:
    runs-on: windows-latest
    timeout-minutes: 0
    
    steps:
      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "PortNumber" -Value 3389 -Type DWord -Force
          
          netsh advfirewall firewall delete rule name="RDP"
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          Restart-Service -Name TermService -Force

      - name: Create Administrator User
        run: |
          $password = "Admin@Secure123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          if (-not (Get-LocalUser -Name "PublicAdmin" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "PublicAdmin" -Password $securePass -AccountNeverExpires
          }
          
          Add-LocalGroupMember -Group "Administrators" -Member "PublicAdmin" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "PublicAdmin" -ErrorAction SilentlyContinue
          
          net user PublicAdmin /active:yes
          net user PublicAdmin /passwordchg:no
          net user PublicAdmin /expires:never
          
          echo "RDP_USER=PublicAdmin" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Download Ngrok
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "$env:TEMP\ngrok.zip"
          Expand-Archive -Path "$env:TEMP\ngrok.zip" -DestinationPath "$env:TEMP\ngrok" -Force
          Copy-Item "$env:TEMP\ngrok\ngrok.exe" "C:\Windows\System32\" -Force

      - name: Start Ngrok Tunnel
        run: |
          Start-Process -FilePath "ngrok.exe" -ArgumentList "tcp 3389 --region us" -WindowStyle Hidden
          Start-Sleep -Seconds 15
          
          $maxAttempts = 15
          $attempt = 0
          $ngrokUrl = $null
          
          while ($attempt -lt $maxAttempts -and !$ngrokUrl) {
              try {
                  $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction SilentlyContinue
                  if ($response.tunnels -and $response.tunnels[0].public_url) {
                      $ngrokUrl = $response.tunnels[0].public_url
                      $ngrokUrl = $ngrokUrl -replace "^tcp://", ""
                      Write-Host "Ngrok URL: $ngrokUrl"
                  }
              } catch {
                  Write-Host "Attempt $($attempt + 1)/$maxAttempts: Waiting for ngrok..."
              }
              $attempt++
              Start-Sleep -Seconds 2
          }
          
          if ($ngrokUrl) {
              echo "NGROK_URL=$ngrokUrl" >> $env:GITHUB_ENV
              Write-Host "✅ Ngrok tunnel established: $ngrokUrl"
          } else {
              echo "NGROK_URL=ngrok-tcp-us.ngrok.io:443" >> $env:GITHUB_ENV
              Write-Host "⚠️ Using default ngrok URL"
          }

      - name: Display Connection Info
        run: |
          Write-Host ""
          Write-Host "════════════════════════════════════════"
          Write-Host "     RDP CONNECTION INFORMATION"
          Write-Host "════════════════════════════════════════"
          
          if ($env:NGROK_URL) {
              Write-Host "Public Address: $env:NGROK_URL"
          } else {
              Write-Host "Local Address: localhost:3389"
          }
          
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host ""
          Write-Host "To connect:"
          Write-Host "1. Open Remote Desktop Connection"
          Write-Host "2. Enter the Public Address"
          Write-Host "3. Click Connect"
          Write-Host "4. Username: $env:RDP_USER"
          Write-Host "5. Password: $env:RDP_PASS"
          Write-Host ""
          Write-Host "⚠️ Keep this workflow running!"
          Write-Host "════════════════════════════════════════"

      - name: Keep Alive
        run: |
          # إنشاء سكربت بسيط
          $scriptFile = "$env:TEMP\rdp_alive.ps1"
          
          # كتابة السكربت سطراً سطراً
          'while ($true) {' | Out-File -FilePath $scriptFile -Encoding UTF8
          '    $count++' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    $time = Get-Date -Format "HH:mm:ss"' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    Write-Host "[$time] RDP Active - Session $count minutes"' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    ' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    # التحقق من RDP' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    $rdpService = Get-Service TermService' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    if ($rdpService.Status -ne "Running") {' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '        Write-Host "Restarting RDP service..."' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '        Start-Service TermService' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '        Start-Sleep -Seconds 5' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    }' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    ' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    # عرض حالة الاتصال' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    try {' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '        $connections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '        if ($connections) {' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '            Write-Host "Port 3389 is listening"' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '        } else {' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '            Write-Host "Port 3389 not listening, restarting firewall rule..."' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '            netsh advfirewall firewall add rule name="RDP-KeepAlive" dir=in action=allow protocol=TCP localport=3389' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '        }' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    } catch {' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '        Write-Host "Checking connection status..."' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    }' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    ' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '    Start-Sleep -Seconds 60' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          '}' | Out-File -FilePath $scriptFile -Encoding UTF8 -Append
          
          # تشغيل السكربت في الخلفية
          Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$scriptFile`"" -WindowStyle Hidden
          
          Write-Host "✅ Keep-alive script started"
          
          # البقاء في العملية الرئيسية
          $minutes = 0
          while ($true) {
              $minutes++
              Write-Host ""
              Write-Host "========================================"
              Write-Host "RDP Session Active - $minutes minutes"
              Write-Host "========================================"
              
              if ($env:NGROK_URL) {
                  Write-Host "Public URL: $env:NGROK_URL"
              }
              
              Write-Host "Local: localhost:3389"
              Write-Host "User: $env:RDP_USER"
              Write-Host "Pass: $env:RDP_PASS"
              Write-Host ""
              Write-Host "To stop: Cancel this workflow in GitHub"
              Write-Host "========================================"
              
              Start-Sleep -Seconds 60
          }
