name: Public RDP on Port 443 with Tunnel

on: 
  workflow_dispatch:

jobs:
  public-rdp:
    runs-on: windows-latest
    timeout-minutes: 0
    
    steps:
      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "PortNumber" -Value 3389 -Type DWord -Force
          
          netsh advfirewall firewall delete rule name="RDP"
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          Restart-Service -Name TermService -Force

      - name: Create Administrator User
        run: |
          $password = "Admin@Secure123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          if (-not (Get-LocalUser -Name "PublicAdmin" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "PublicAdmin" -Password $securePass -AccountNeverExpires
          }
          
          Add-LocalGroupMember -Group "Administrators" -Member "PublicAdmin" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "PublicAdmin" -ErrorAction SilentlyContinue
          
          net user PublicAdmin /active:yes
          net user PublicAdmin /passwordchg:no
          net user PublicAdmin /expires:never
          
          echo "RDP_USER=PublicAdmin" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Download Ngrok
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "$env:TEMP\ngrok.zip"
          Expand-Archive -Path "$env:TEMP\ngrok.zip" -DestinationPath "$env:TEMP\ngrok" -Force
          Copy-Item "$env:TEMP\ngrok\ngrok.exe" "C:\Windows\System32\" -Force

      - name: Start Ngrok Tunnel
        run: |
          # تشغيل ngrok
          Start-Process -FilePath "ngrok.exe" -ArgumentList "tcp 3389 --region us" -WindowStyle Hidden
          
          # الانتظار
          Start-Sleep -Seconds 15
          
          # الحصول على العنوان
          $maxAttempts = 15
          $attempt = 0
          $ngrokUrl = $null
          
          while ($attempt -lt $maxAttempts -and !$ngrokUrl) {
              try {
                  $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction SilentlyContinue
                  if ($response.tunnels -and $response.tunnels[0].public_url) {
                      $ngrokUrl = $response.tunnels[0].public_url
                      $ngrokUrl = $ngrokUrl -replace "^tcp://", ""
                      Write-Host "Ngrok URL: $ngrokUrl"
                  }
              } catch {
                  Write-Host "Attempt $($attempt + 1)/$maxAttempts: Waiting for ngrok..."
              }
              $attempt++
              Start-Sleep -Seconds 2
          }
          
          if ($ngrokUrl) {
              echo "NGROK_URL=$ngrokUrl" >> $env:GITHUB_ENV
              Write-Host "✅ Ngrok tunnel established: $ngrokUrl"
          } else {
              echo "NGROK_URL=ngrok-tcp-us.ngrok.io:443" >> $env:GITHUB_ENV
              Write-Host "⚠️ Using default ngrok URL"
          }

      - name: Display Connection Info
        run: |
          Write-Host ""
          Write-Host "════════════════════════════════════════"
          Write-Host "     RDP CONNECTION INFORMATION"
          Write-Host "════════════════════════════════════════"
          
          if ($env:NGROK_URL) {
              Write-Host "Public Address: $env:NGROK_URL"
          } else {
              Write-Host "Local Address: localhost:3389"
          }
          
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host ""
          Write-Host "To connect:"
          Write-Host "1. Open Remote Desktop Connection"
          Write-Host "2. Enter the Public Address"
          Write-Host "3. Click Connect"
          Write-Host "4. Username: $env:RDP_USER"
          Write-Host "5. Password: $env:RDP_PASS"
          Write-Host ""
          Write-Host "⚠️ Keep this workflow running!"
          Write-Host "════════════════════════════════════════"

      - name: Keep Alive with Simple Script
        run: |
          # إنشاء سكربت بسيط للحفاظ على الاتصال
          $scriptContent = @"
          `$count = 0
          while (`$true) {
              `$count++
              `$time = Get-Date -Format "HH:mm:ss"
              Write-Host "[`$time] RDP Active - Session `$count minutes"
              
              # التحقق من RDP
              `$rdpService = Get-Service TermService
              if (`$rdpService.Status -ne "Running") {
                  Write-Host "Restarting RDP service..."
                  Start-Service TermService
                  Start-Sleep -Seconds 5
              }
              
              # عرض حالة الاتصال
              try {
                  `$connections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue
                  if (`$connections) {
                      Write-Host "Port 3389 is listening"
                  } else {
                      Write-Host "Port 3389 not listening, restarting firewall rule..."
                      netsh advfirewall firewall add rule name="RDP-KeepAlive" dir=in action=allow protocol=TCP localport=3389
                  }
              } catch {
                  Write-Host "Checking connection status..."
              }
              
              Start-Sleep -Seconds 60
          }
"@
          
          # حفظ السكربت
          $scriptPath = "$env:TEMP\rdp_alive.ps1"
          $scriptContent | Out-File -FilePath $scriptPath -Encoding UTF8
          
          # تشغيل السكربت في الخلفية
          Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -File `"$scriptPath`"" -WindowStyle Hidden
          
          Write-Host "✅ Keep-alive script started"
          
          # البقاء في العملية الرئيسية
          $minutes = 0
          while ($true) {
              $minutes++
              Write-Host ""
              Write-Host "========================================"
              Write-Host "RDP Session Active - $minutes minutes"
              Write-Host "========================================"
              
              if ($env:NGROK_URL) {
                  Write-Host "Public URL: $env:NGROK_URL"
              }
              
              Write-Host "Local: localhost:3389"
              Write-Host "User: $env:RDP_USER"
              Write-Host "Pass: $env:RDP_PASS"
              Write-Host ""
              Write-Host "To stop: Cancel this workflow in GitHub"
              Write-Host "========================================"
              
              Start-Sleep -Seconds 60
          }

      - name: Cleanup (if stopped)
        if: always()
        run: |
          Write-Host "Cleaning up..."
          
          # إيقاف ngrok
          Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
          
          # إعادة تعيين RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
          
          # تمكين جدار الحماية
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
          
          # حذف قواعد جدار الحماية
          netsh advfirewall firewall delete rule name="RDP"
          netsh advfirewall firewall delete rule name="RDP-KeepAlive"
          
          Write-Host "✅ Cleanup completed"
