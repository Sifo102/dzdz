name: RDP
on:
  workflow_dispatch:
    inputs:
      zerotier_network:
        description: 'ZeroTier Network ID'
        required: true
        type: string
jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 10080
    steps:
      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          netsh advfirewall firewall add rule name="RDP-ZeroTier" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force
          Write-Host "‚úÖ RDP configured successfully"

      - name: Create User Account
        run: |
          $password = "P@ssw0rd123"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          Remove-LocalUser -Name "SIFODZ" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          New-LocalUser -Name "SIFODZ" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "SIFODZ"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "SIFODZ"
          Enable-LocalUser -Name "SIFODZ"
          Write-Host "‚úÖ User account created"

      - name: Install ZeroTier
        run: |
          $zerotierUrl = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          $installerPath = "$env:TEMP\zerotier.msi"
          Invoke-WebRequest -Uri $zerotierUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart", "ALLUSERS=1" -Wait
          Remove-Item $installerPath -Force
          Start-Sleep -Seconds 15
          Write-Host "‚úÖ ZeroTier installed successfully"

      - name: Join ZeroTier Network Using Service
        run: |
          $networkId = "${{ github.event.inputs.zerotier_network }}"
          
          if (-not $networkId) {
              Write-Host "‚ùå No ZeroTier Network ID provided"
              Write-Host "üìã Create a network at: https://my.zerotier.com"
              exit 1
          }
          
          Write-Host "üîó Joining ZeroTier network: $networkId"
          
          # Method 1: Create network config file (most reliable)
          $configDir = "$env:ProgramData\ZeroTier\One\networks.d"
          New-Item -ItemType Directory -Path $configDir -Force
          $configFile = "$configDir\$networkId.conf"
          Set-Content -Path $configFile -Value ""
          
          Write-Host "‚úÖ Created network config file"
          
          # Restart service to apply changes
          Restart-Service -Name "ZeroTier One Service" -Force
          Write-Host "‚úÖ ZeroTier service restarted"
          
          # Wait for connection
          Write-Host "üîÑ Waiting for network connection (30 seconds)..."
          Start-Sleep -Seconds 30

      - name: Get ZeroTier IP Address
        run: |
          Write-Host "üîç Searching for ZeroTier IP address..."
          $ztIP = $null
          $maxAttempts = 10
          
          for ($i = 1; $i -le $maxAttempts; $i++) {
              # Method: Check network adapters for ZeroTier
              $adapters = Get-NetAdapter -Name "ZeroTier*" -ErrorAction SilentlyContinue
              
              if ($adapters) {
                  foreach ($adapter in $adapters) {
                      $ipAddresses = Get-NetIPAddress -InterfaceIndex $adapter.ifIndex -AddressFamily IPv4 -ErrorAction SilentlyContinue
                      if ($ipAddresses -and $ipAddresses.IPAddress) {
                          $ztIP = $ipAddresses.IPAddress
                          Write-Host "‚úÖ Found ZeroTier IP via network adapter: $ztIP"
                          break
                      }
                  }
              }
              
              if ($ztIP) {
                  break
              }
              
              Write-Host "‚è≥ Attempt $i/$maxAttempts - Waiting for IP assignment..."
              Start-Sleep -Seconds 10
          }
          
          if ($ztIP) {
              echo "ZEROTIER_IP=$ztIP" >> $env:GITHUB_ENV
              Write-Host "üéØ ZeroTier IP Address: $ztIP"
          } else {
              Write-Host "‚ö†Ô∏è ZeroTier IP not assigned yet - requires manual approval"
              Write-Host "üìã Go to: https://my.zerotier.com and authorize this device"
              echo "ZEROTIER_IP=pending_approval" >> $env:GITHUB_ENV
          }

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "üéØ ==================== ZEROTIER RDP ===================="
          Write-Host "üë§ Username: SIFODZ"
          Write-Host "üîë Password: P@ssw0rd123"
          Write-Host "üåê ZeroTier Network: ${{ github.event.inputs.zerotier_network }}"
          
          if ($env:ZEROTIER_IP -and $env:ZEROTIER_IP -ne "pending_approval") {
              Write-Host "üìç ZeroTier IP: $env:ZEROTIER_IP"
              Write-Host "üîå Port: 3389"
              Write-Host ""
              Write-Host "üîß HOW TO CONNECT:"
              Write-Host "   1. Install ZeroTier from: https://www.zerotier.com/download/"
              Write-Host "   2. Join network: ${{ github.event.inputs.zerotier_network }}"
              Write-Host "   3. Go to https://my.zerotier.com"
              Write-Host "   4. Authorize BOTH devices (this one and yours)"
              Write-Host "   5. Connect RDP to: $env:ZEROTIER_IP"
              Write-Host "   6. Username: SIFODZ"
              Write-Host "   7. Password: P@ssw0rd123"
          } else {
              Write-Host "üìç ZeroTier IP: Pending Approval"
              Write-Host ""
              Write-Host "üìã REQUIRED ACTION:"
              Write-Host "   1. Go to: https://my.zerotier.com"
              Write-Host "   2. Find network: ${{ github.event.inputs.zerotier_network }}"
              Write-Host "   3. Check the 'Auth' checkbox for this device"
              Write-Host "   4. Wait 1-2 minutes for IP assignment"
              Write-Host "   5. Refresh this page to see the IP"
          }
          
          Write-Host ""
          Write-Host "üîí SECURITY FEATURES:"
          Write-Host "   ‚Ä¢ End-to-End Encryption"
          Write-Host "   ‚Ä¢ Private Network Isolation" 
          Write-Host "   ‚Ä¢ Enhanced RDP Security"
          Write-Host ""
          Write-Host "‚è∞ Duration: 7 DAYS"
          Write-Host "=========================================================="
          Write-Host ""

      - name: Maintain Connection
        run: |
          $startTime = Get-Date
          Write-Host "üîÑ ZeroTier RDP Server is running..."
          
          while ($true) {
              $currentTime = Get-Date
              $elapsed = $currentTime - $startTime
              $hours = [math]::Round($elapsed.TotalHours, 1)
              
              # Monitor RDP service
              $rdpService = Get-Service -Name TermService
              if ($rdpService.Status -ne 'Running') {
                  Write-Host "üîÑ Restarting RDP Service..."
                  Start-Service -Name TermService
              }
              
              # Monitor ZeroTier service
              $ztService = Get-Service -Name "ZeroTier One Service" -ErrorAction SilentlyContinue
              if (-not $ztService -or $ztService.Status -ne 'Running') {
                  Write-Host "üîÑ Starting ZeroTier Service..."
                  Start-Service -Name "ZeroTier One Service" -ErrorAction SilentlyContinue
              }
              
              # Update IP display if it was pending
              if ($env:ZEROTIER_IP -eq "pending_approval") {
                  $adapters = Get-NetAdapter -Name "ZeroTier*" -ErrorAction SilentlyContinue
                  if ($adapters) {
                      $ipAddresses = Get-NetIPAddress -InterfaceIndex $adapters.ifIndex -AddressFamily IPv4 -ErrorAction SilentlyContinue
                      if ($ipAddresses -and $ipAddresses.IPAddress) {
                          $newIP = $ipAddresses.IPAddress
                          echo "ZEROTIER_IP=$newIP" >> $env:GITHUB_ENV
                          Write-Host "üéØ ZeroTier IP Assigned: $newIP"
                      }
                  }
              }
              
              if ($env:ZEROTIER_IP -and $env:ZEROTIER_IP -ne "pending_approval") {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚úÖ RDP Active - $hours hours - IP: $env:ZEROTIER_IP"
              } else {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚è≥ Waiting Approval - $hours hours"
              }
              
              Start-Sleep -Seconds 60
          }
